<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Brown Stone  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20100928

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Autotest-Autotest Remote (Autoserv)（一）</title>
<link href="../../../../theme/css/style.css" rel="stylesheet" type="text/css" media="screen" />
<link href="../../../../" type="application/atom+xml" rel="alternate" title="Hi | World ATOM Feed" />
</head>
<body>
<div id="wrapper">
	<div id="page">
		<div id="page-bgtop">
			<div id="page-bgbtm">
    
                        	<div id="content">
					<div class="post">
						<h2 class="title"><a href="2015/08/20/autotest/">Autotest-Autotest Remote (Autoserv)（一）</a></h2>
						<p class="meta"><span class="date">日期 四 20 八月 2015 </span><span class="posted">By <a href="#">penglee</a></span><span>&nbsp; | 分类 : <a href="../../../../category/autotestzhuan-ti.html">Autotest专题</a></span></p>
					<p class="meta">Tags : <span><a href="../../../../tag/zi-dong-hua-ce-shi.html">自动化测试</a> / </span>
</p>	
						<div style="clear: both;">&nbsp;</div>
						<div class="entry">
						 <body><p><img class="img-responsive" height="280" src="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/autotestlogo.png?raw=true" width="480"/></p>
<p>Autoserv 是&ldquo;自动化机器控制&ldquo;的框架
Autoserv 目的是控制机器，它可以：</p>
<ul>
<li>电源管理</li>
<li>安装内核</li>
<li>修改bootloader
*　运行任意命令</li>
<li>运行Autotest Local(客户端）测试</li>
<li>传输文件</li>
</ul>
<p>被控制的机器可以是：</p>
<ul>
<li>本机</li>
<li>远程机器（通过ssh 和　conmux)</li>
<li>虚拟机(通过ＫＶＭ）</li>
</ul>
<h2 id="kong-zhi-wen-jian">控制文件</h2>
<p>类似于autotest,Autoserv同样使用控制文件。这些控制文件和autotest使用不同的命令，但是像autotest一样包含一些内部的可以调研python解释器的功能。</p>
<p>这里有一个控制文件的例子，用来控制远程host安装.dep内核。若文件存在server/目录并且命名为example.control,可以在server/目录通过./autotest-remote example.control调用：</p>
<div class="highlight"><pre><span></span>remote_host = host.SSHHost("192.168.1.1")
print remote_host.run("uname -a").stdout

kernel = deb_kernel.DEBKernel()
kernel.get("/var/local/linux-2.6.22.deb")

print kernel.get_version()
print kernel.get_image_name()
print kernel.get_initrd_name()

kerne.install(remote_host)

remote_host.reboot()

print remote_host.run("uname -a").stdout
</pre></div>
<h2 id="hosts">Hosts</h2>
<p>"Host"类是Autoserv控制文件的操作对象。这些Ｈost类通过ssh/conmux或virtual机控制机器。这些代码结构支持添加其他类型的hosts.如果想添加
其他类型的host，需要确保添加到server/hosts/<strong>init</strong>.py文件。</p>
<h3 id="hostde-zhu-yao-fang-fa">Host的主要方法</h3>
<p>以下是最常用的host的方法。每个类型的host都需要包含这些方法，起码支持列表选项中的方法。特定的host需要支持更多的命令和选项。关于这些信息，可以查看　
ａｕｔｏｔｅｓｔ子目录server/client中源码文件。下面的列表只是一个基本的汇总，不是那些源码文件的功能的头文件。特别是，需要查看一下server/hosts/ssh_host.py文件。</p>
<ul>
<li>run(command)</li>
<li>reboot()</li>
<li>get_file(source, dest)</li>
<li>send_file(source, dest)</li>
<li>get_tmp_dir</li>
<li>is_up()</li>
<li>wait_up(timeout)</li>
<li>wait_down(timeout)</li>
<li>get_num_cpu()</li>
</ul>
<h4 id="cmdresult-lei">CmdResult　类</h4>
<p>run()调用的返回值是一个CmdResult类。该类包含了有关命令和其执行信息。这个类的定义和文档信息可以在server/hosts/base_classes.py文件中查看。
CmdResult类可以打印并且输出其所有的信息。它的每个字段都可以单独访问。这个字段的列表是：</p>
<ul>
<li>command: 包含命令行本身的字符</li>
<li>exit_status: 进程整数退出代码</li>
<li>stdout:包含程序标准输出的字符串</li>
<li>stderr: 包含程序错误输出的字符串</li>
<li>duration: 程序运行的持续时间</li>
<li>aborted:　导致终端命令中止的信号（０）</li>
</ul>
<h3 id="hostde-zhu-yao-lei-xing_1">Host的主要类型</h3>
<h4 id="sshhost">SSHHost</h4>
<p>SSHHost是非常重要和实用的host类型。它可以通过ssh会话控制远程机器。它支持所有的hosts的基本方法和run(）功能，支持超时。SSHHost通过
ssh运行命令，通过scp进行文件传输。</p>
<p>如果想采用SSHHost，必须设置远程机器无密码登陆，如通过公共秘钥。一个SSHHost对象建立在指定的host name,任意的用户名称和端口号。</p>
<h4 id="conmuxsshhost">ConmuxSSHHost</h4>
<p>ConmuxSSHHost是SSHHost的扩展。它通过Conmux来控制远程机器。可以通过hardreset()方法进行硬复位。</p>
<h4 id="sitehost">SiteHost</h4>
<p>Site host 是一个空类，可以添加特殊的方法或支持所以类型hostts的属性。它定义在server/hosts/site_host_py文件中，不过可能是空的。
创建这样的一个类的灵感来自于如更新bios，侦测硬件版本或一些对普通用户不常用的操作。</p>
<h4 id="kvmguest">KVMGuest</h4>
<p>KVMGuest 表示可以运行程序的KVM 虚拟机。　它必须绑定到其他host, 这些机器实际上运行于虚拟层。KVMGuest和SSHHost非常类似，但它可以通过hardreset方法（Guest中）调用hypervisor的命令去实现&rdquo;硬复位&ldquo;.可以通过查看<a href="">KVM section</a>查看更多的KVM和KVMguest信息。</p>
<h4 id="bootloader">Bootloader</h4>
<p>Boottool 是一个查询和修改bootloader文件的perl脚本。Autoserv提供Bootloader类，是围绕boottool的包装。Ａutoserv 在需要时会第一时间将boottool脚本自动复制到一个临时目录。可以通过查看server/hosts/bootloader.py查看支持方法的信息。其中最重要的一个方法是add_kernel()</p>
<p>当添加了一个新内核是，boottool会复用上一个内核的命令行及配置，来实现一个新的启动项菜单。</p>
<h2 id="installableobject_2">InstallableObject</h2>
<p>InstallableObject　表示一个可以再host上安装软件包。通过下面两个方法实现：
<em> get(location)
</em> install(host)</p>
<p>get()表示获取安装包，它可以获取多种类型保存位置的包：
<em> 本地目录
</em> URL地址
<em> python文件对象
</em> 如果参数不是上述类型，get()会默认将获取的内容当为包内容</p>
<p>get()获取的软件包，通常会放到一个临时目录。这种方式可以一次获取，安装到多台hosts上面。install()会安装包，当通常会装到一个临时目录。</p>
<h2 id="autotest-support">Autotest Support</h2>
<p>Autoserv包含autotest的一些具体支持。它可以安装autotest到一个客户端，可以运行客户端的测试并且取回测试结果。这是通过autotest和运行server/autotest.py中的
类实现的。Auotest对象是一个installableＯbject.要想使用它，必须：
<em> 指定来源后通过get()获取，autotest对象有点特别。如果没有指定任何来源，将会自动从autotest　ＳＶＮ库自动获取。而且会在目标主机中完成。
</em> 当通过install()安装时，autotest会查找一个/etc/autotest.conf的文件：</p>
<div class="highlight"><pre><span></span>autodir=/usr/local/autotest/
</pre></div>
<ul>
<li>run()运行一个控制文件的语法如下：run(control_file, results_dir, host).control_file 参数支持get()和intallableObject相同类型的值。</li>
</ul>
<p>下面是一个Autoserv控制文件和运行Autotest job的例子。测试结果会传输到server的&ldquo;job_results"目录下。
    remote_host = hosts.SSHHost("192.168.1.1")</p>
<div class="highlight"><pre><span></span>at = autotest.Autotest()
at.get("/var/local/autotest/client")
at.install(remote_host)

control_file = """
job.profilers.add("oprofile", events= ["CPU_CLK_UNHALED:8000"])
job.run_test("linux_stress")
"""

results_dir = "job_results"

at.run(control_file, results_dir, remote_host)
</pre></div>
<h2 id="kernel-objects">Kernel Objects</h2>
<p>Kernel Objects 是另一个类型的InstallableObjects.计划支持内核源码编译及.rpm和.deb包安装。最初，只支持.deb格式内核。现在已经支持源码格式的内核。
kernels支持依赖以下方法：</p>
<ul>
<li>get(location)
    用户installableObject方法</li>
<li>install(host, extra arguments to boottool).当一个内核安装在host后，会使用bootbool使它自己编程默认的启动内核。如果需要指定特别的内核参数，
需要可以添加，并传递给add_kernel()方法用来启动内核。</li>
<li>get_version()</li>
<li>get_image_name()</li>
<li>get_image_name()</li>
</ul>
<p>同样，可以通过查看源码了解更多详细信息，如server/deb_kernel.py</p>
<p>DEBKernels　有一个额外的方法，host直接提取内核。这个方法可以直接将包解压到指定的host.这样可以不经过安装，可以直接访问包的内容。这个功能比较常用的地方就是
kvm和qumu的　-kernel选项。</p>
<p>下面给出一个Autoserv安装内核的控制文件的例子：</p>
<div class="highlight"><pre><span></span>rh = hosts.SSHHost("192.168.1.1")

print rh.run("uname -a").stdout

kernel = deb_kernel.DEBKernel()
kernel.get("/var/local/linux-2.6.22.deb")

kernel.install(rh)

rh.reboot()

print rh.run("uname -a").stdout
</pre></div>
<p>一个类似的例子使用RPM形式的kernel，并让指定启动参数（autoserv -m host1, host2 install-rpm):</p>
<div class="highlight"><pre><span></span>if not machines:
    raise "Specify the machines to run on via the -m flag"
hosts = [hosts.SSHHost(h) for h in machines]

kernel = rpm_kernel.RPMKernel()
kernel.get('/stuff/kernels/kernel-smp-2.6.18.x86_64.rpm')

for host in hosts:
    print host.run("uame -a").stdout
    kernel.install(host, default=True)
    host.reboot()
    print host.run("uname -a").stdout

print "Done"
</pre></div>
<p>未完待续</p>
<p>Top<a href="">^</a></p>
<p>上一篇<a href="https://king32783784.github.io/2015/08/19/autotest/">Autotest：Autotest-others&gt;&gt;</a>
下一篇<a href="https://king32783784.github.io/2015/08/21/autotest/">Autotest:Autotest-Autotest Remote (Autoserv)(二）&gt;&gt;&gt;</a></p></body>	
						</div>
					</div>
			      
					<div style="clear: both;">&nbsp;</div>
                                        <div class="post">
                                        <h2 class="title">Commentaires !</h2>
                                            <div id="disqus_thread"></div>
                                            <script type="text/javascript">
                                               var disqus_identifier = "2015/08/20/autotest/";
                                               (function() {
                                               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                               dsq.src = 'https://king32783784.disqus.com/embed.js';
                                               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                                              })();
                                            </script>
                                        </div>
				</div>
				<!-- end #content -->
				<div id="sidebar">
					<div id="logo">
						<h1><a href="../../../..">Hi | World</a></h1>
					</div>
					<div id="menu">
						<ul>
							<li ><a href="../../../..">首页</a></li>
							<li ><a href="../../../../archives.html">归档</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/opensource.html">开源项目</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/links.html">链接</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/Reference material.html">参考资料</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/todo list.html">Todo List</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/tools.html">工具集</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/aboutme.html">关于我</a></li>
						</ul>
					</div>
					<ul>
						<li>
							<h2>分类列表</h2>
							<ul>
								 <li ><a href="../../../../category/misc.html">misc</a></li>
								 <li class="active"><a href="../../../../category/autotestzhuan-ti.html">Autotest专题</a></li>
								 <li ><a href="../../../../category/suan-fa.html">算法</a></li>
								 <li ><a href="../../../../category/dockerzhuan-ti.html">Docker专题</a></li>
								 <li ><a href="../../../../category/linux.html">Linux</a></li>
								 <li ><a href="../../../../category/linux-benchmark.html">linux-benchmark</a></li>
								 <li ><a href="../../../../category/linux-zi-dong-hua-ce-shi.html">linux-自动化测试</a></li>
								 <li ><a href="../../../../category/unixhuan-jing-bian-cheng.html">unix环境编程</a></li>
								 <li ><a href="../../../../category/xing-neng-ce-shi.html">性能测试</a></li>
							</ul>
						</li>
						<li>
						        <h2>Tags</h2>
						        <ul>
                                                                <li><a href="../../../../tag/selenium.html">Selenium</a></li>
                                                                <li><a href="../../../../tag/zi-dong-hua-ce-shi.html">自动化测试</a></li>
                                                                <li><a href="../../../../tag/ltp.html">LTP</a></li>
                                                                <li><a href="../../../../tag/shell.html">shell</a></li>
                                                                <li><a href="../../../../tag/suan-fa.html">算法</a></li>
                                                                <li><a href="../../../../tag/xing-neng-ce-shi.html">性能测试</a></li>
                                                                <li><a href="../../../../tag/python.html">Python</a></li>
                                                                <li><a href="../../../../tag/docker.html">Docker</a></li>
                                                                <li><a href="../../../../tag/benchmark.html">benchmark</a></li>
                                                                <li><a href="../../../../tag/qi-ta.html">其他</a></li>
                                                                <li><a href="../../../../tag/unixbian-cheng.html">unix编程</a></li>
                                                                <li><a href="../../../../tag/linux.html">Linux</a></li>
                                                                <li><a href="../../../../tag/pyunit.html">PyUnit</a></li>
						        </ul>
						</li>
						
						
					</ul>
				</div>
				<!-- end #sidebar -->
				<div style="clear: both;">&nbsp;</div>
			</div>
		</div>
	</div>
	<!-- end #page -->

<div id="footer">
	<p>Copyright (c) 2008 Sitename.com. All rights reserved. Design by <a href="http://www.freecsstemplates.org/">CSS Templates</a>.</p>
	<p>Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
</p>
</div>
<!-- end #footer -->
</body>
</html>