<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Brown Stone  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20100928

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Autotest-Linux distribution detection</title>
<link href="../../../../theme/css/style.css" rel="stylesheet" type="text/css" media="screen" />
<link href="../../../../" type="application/atom+xml" rel="alternate" title="Hi | World ATOM Feed" />
</head>
<body>
<div id="wrapper">
	<div id="page">
		<div id="page-bgtop">
			<div id="page-bgbtm">
    
                        	<div id="content">
					<div class="post">
						<h2 class="title"><a href="2015/08/18/autotest/">Autotest-Linux distribution detection</a></h2>
						<p class="meta"><span class="date">日期 二 18 八月 2015 </span><span class="posted">By <a href="#">penglee</a></span><span>&nbsp; | 分类 : <a href="../../../../category/autotestzhuan-ti.html">Autotest专题</a></span></p>
					<p class="meta">Tags : <span><a href="../../../../tag/zi-dong-hua-ce-shi.html">自动化测试</a> / </span>
</p>	
						<div style="clear: both;">&nbsp;</div>
						<div class="entry">
						 <body><p><img class="img-responsive" height="280" src="https://github.com/king32783784/king32783784.github.io/blob/master/tmpfile/autotestlogo.png?raw=true" width="480"/></p>
<h2 id="linuxfa-xing-ban-jian-ce">linux发行版检测</h2>
<p>Autotest有个功能,就是让测试清晰了解到它运行在什么样的发行版上.
这个功能是由probe类群的实现和注册实现的.
这些probe类可以检查运行的系统的信息,比如发行版的release文件,二进制信息(如包管理)等.</p>
<h3 id="kuai-su-jian-cha-fa-xing-ban">快速检查发行版</h3>
<p>autotest.client.shared.distro 模块提供一些APIS,最简单的就是使用detect().
它的用法简单命了:</p>
<div class="highlight"><pre><span></span>    <span class="kn">from</span> <span class="nn">autotest.client.shared</span> <span class="kn">import</span> <span class="n">distro</span>
    <span class="n">detected_distro</span> <span class="o">=</span> <span class="n">distro</span><span class="o">.</span><span class="n">detect</span><span class="p">()</span>
</pre></div>
<p>这样就可以返回发行版检测的结果,但是不太适用于<strong>UNKNOWN_DISIRO</strong>.</p>
<ul>
<li>name</li>
<li>version</li>
<li>release</li>
<li>arch</li>
</ul>
<p>例如:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;detected_distro = distro.detect()
&gt;&gt;&gt;print detected_distro.name
redhat
</pre></div>
<h3 id="wei-zhi-fa-xing-ban">未知发行版</h3>
<p>当检测机制不能检测到发行版,仍会返回一个LinuxDistro实例,但是它的name,version等信息比较特殊.</p>
<div class="highlight"><pre><span></span> autotest.clientshared.distro.UNKNOWN_DISIRO
 =&lt;LinuxDistro: name=unnknown, version=0, realease=0, arch=unknown&gt;
</pre></div>
<p>意味着,这个发行版不能找到对应的匹配信息.</p>
<h3 id="bian-xie-yi-ge-fa-xing-ban-probe">编写一个发行版probe</h3>
<p>为目标发行版编写一个probe最简单的方式就是使用现有的Probe类的功能.
如果,不打算采用Probe的话,也应该尽量继承probe类,或则提供类似的接口.</p>
<h4 id="jian-cha-fa-xing-ban-de-ming-zi">检查发行版的名字</h4>
<p>最简单的探针就是查看存在的文件并返回发行版的名字.</p>
<div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">ReadHatProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/redhat-realease'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'redhat'</span>
</pre></div>
<p>如果要使用probe,需要先注册:</p>
<div class="highlight"><pre><span></span>    <span class="kn">from</span> <span class="nn">autotest.client.shared</span> <span class="kn">import</span> <span class="n">distro</span>
    <span class="n">distro</span><span class="o">.</span><span class="n">register_probe</span><span class="p">(</span><span class="n">RedHatProbe</span><span class="p">)</span>
</pre></div>
<p>这是一个有效的例子，但只有发行版的名字,通常你的目标应该是更多的信息，如版本号。</p>
<h4 id="zhen-ce-fa-xing-ban-de-ming-zi-he-ban-ben">侦测发行版的名字和版本</h4>
<p>如果,你需要侦测发行版的版本信息,可以使用Probe类的 Probe.CHECK_VERSION_REGEX</p>
<div class="highlight"><pre><span></span>Probe.CHECK_VERSION_REGEX=None
</pre></div>
<h4 id="zhu-ce-zi-ji-de-probes">注册自己的probes</h4>
<p>Autotest不仅仅可以使用自带的probes,而且可以添加自己的probes用于系统的侦测.
注册的简单方式就剩调用register_probe():</p>
<div class="highlight"><pre><span></span>autotest.client.shared.distro.register_probe(probe_class)
</pre></div>
<p>注意,要注册的自己的probes必须是probe的子类.</p>
<h3 id="apican-kao_1">API参考</h3>
<p><strong>LinuxDistro</strong></p>
<p>class autotest.client.shared.distro.LinuxDistro(name, version, release, arch) <a href="#linuxdistro">源码</a></p>
<p>收集linux发行版信息的简单方式.</p>
<p><strong>Probe</strong></p>
<p>class autotest.client.shared.distro.Probe  <a href="#Probe">源码</a></p>
<p>CHECK_FILE=None</p>
<p>CHECK_FILE_CONTAINS=None</p>
<p>CHECK_FILE_DISTRO_NAME =None</p>
<p>CHECK_VERSION_REGEX = None</p>
<p>Check_name_for_file()</p>
<p>check_name_for_file_contains()</p>
<p>check_release()</p>
<p>check_version()</p>
<p>get_distro()</p>
<p>name_for_file()</p>
<p>name_for_file_contains()</p>
<p>release()</p>
<p>version()</p>
<p><strong>register</strong>_<strong>probe()</strong></p>
<p>autotest.client.shared.distro.register_probe(probe_class) <a href="#register_probe">源码</a></p>
<p>注册probe</p>
<p><strong>detect()</strong></p>
<p>autotest.client.shared.distro.detect() <a href="#detect">源码</a></p>
<p>尝试检测这台机器上的Linux发行版本</p>
<p><strong>Source code for autotest.client.shared.distro</strong></p>
<div class="highlight"><pre><span></span>    <span class="sd">"""</span>
<span class="sd">    This module provides the client facilities to detect the Linux Distribution</span>
<span class="sd">    it's running under.</span>

<span class="sd">    This is a replacement for the get_os_vendor() function from the utils modules.</span>
<span class="sd">    """</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">platform</span>
    <span class="kn">import</span> <span class="nn">re</span>


    <span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'LinuxDistro'</span><span class="p">,</span>
               <span class="s1">'UNKNOWN_DISTRO_NAME'</span><span class="p">,</span>
               <span class="s1">'UNKNOWN_DISTRO_VERSION'</span><span class="p">,</span>
               <span class="s1">'UNKNOWN_DISTRO_RELEASE'</span><span class="p">,</span>
               <span class="s1">'UNKNOWN_DISTRO_ARCH'</span><span class="p">,</span>
               <span class="s1">'Probe'</span><span class="p">,</span>
               <span class="s1">'register_probe'</span><span class="p">,</span>
               <span class="s1">'detect'</span><span class="p">]</span>
    <span class="c1"># [__all__用法]()</span>

    <span class="c1"># pylint: disable=R0903</span>
</pre></div>
<p><strong>LinuxDistro</strong> <span id="linuxdistro">:</span></p>
<div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">LinuxDistro</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Simple collection of infomation for a Linux Distribution</span>
<span class="sd">        '''</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">arch</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">            Initalizes a new Linux Distro</span>
<span class="sd">            :param name: 一个简单的区别于其他发型版的名字</span>
<span class="sd">            :type name : 字符</span>
<span class="sd">            :parm vesion:发行版的主版本.</span>
<span class="sd">            :type vesion: 字符</span>
<span class="sd">            :param release: 发行版的发型号或子版本.</span>
<span class="sd">            :type vesion:字符</span>
<span class="sd">            :parm arch: 发行版的平台架构信息,如interl/amd 32bit/64bit</span>
<span class="sd">            :type arch: 字符</span>
<span class="sd">            '''</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">arch</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># [Difference between __str__ and __repr__ in Python](http://stackoverflow.com/questions/1436703/difference-between-str-and-repr-in-python)</span>
            <span class="k">return</span> <span class="s1">'&lt;LinuxDistro: name=</span><span class="si">%s</span><span class="s1">, version=</span><span class="si">%s</span><span class="s1">, release=</span><span class="si">%s</span><span class="s1">, arch=</span><span class="si">%s</span><span class="s1">&gt;'</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">)</span>


    <span class="n">UNKNOWN_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'unknown'</span>
    <span class="n">UNKNOWN_DISTRO_VERSION</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">UNKNOWN_DISTRO_RELEASE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">UNKNOWN_DISTRO_ARCH</span> <span class="o">=</span> <span class="s1">'unknown'</span>   <span class="c1"># 定义未知发行版默认信息</span>

    <span class="c1">#: 未知发行版,反馈以下信息</span>
    <span class="n">UNKNOWN_DISTRO</span> <span class="o">=</span> <span class="n">LinuxDistro</span><span class="p">(</span><span class="n">UNKNOWN_DISTRO_NAME</span><span class="p">,</span>
                                 <span class="n">UNKNOWN_DISTRO_VERSION</span><span class="p">,</span>
                                 <span class="n">UNKNOWN_DISTRO_RELEASE</span><span class="p">,</span>
                                 <span class="n">UNKNOWN_DISTRO_ARCH</span><span class="p">)</span>
</pre></div>
<p><strong>Probe</strong> <span id="Probe">:</span></p>
<div class="highlight"><pre><span></span>    <span class="k">class</span> <span class="nc">probe</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

        <span class="sd">'''</span>
<span class="sd">        探测机器信息并且确认是否存在的发行版</span>
<span class="sd">        '''</span>
        <span class="c1">#:指定运行机器上发行版中的文件.</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#:设置指向文件的检查内容,默认为None,只检查是否存在</span>
        <span class="n">CHECK_FILE_CONTAINS</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#:如果文件指定,指定发行版名字</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1">#:指定发行版版本</span>
        <span class="n">CHECK_VERSION_REGEX</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">check_name_for_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
            <span class="sd">'''</span>
<span class="sd">            查找一个文件并返回distro.确认是否指定了特定文件</span>
<span class="sd">            '''</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">name_for_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">            获取distro名称,如果"CHECK_FILE"设置并且存在</span>
<span class="sd">            '''</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_name_for_file</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE_DISTRO_NAME</span>

        <span class="k">def</span> <span class="nf">check_name_for_file_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">            该类查找text并返回distro.</span>
<span class="sd">            The conditions that must be true include the file that identifies the</span>
<span class="sd">            distro file being set (:attr:`CHECK_FILE`), the text to look for</span>
<span class="sd">            inside the distro file (:attr:`CHECK_FILE_CONTAINS`) and the name</span>
<span class="sd">            of the distro to be returned (:attr:`CHECK_FILE_DISTRO_NAME`)</span>
<span class="sd">            '''</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE_CONTAINS</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">name_for_file_contains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">             获取distro如果CHECK_FILE指定并且有效</span>
<span class="sd">            '''</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_name_for_file_contains</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE_CONTAINS</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE_DISTRO_NAME</span>

        <span class="k">def</span> <span class="nf">check_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">             检查在文件中是否找到regex并返回distro</span>
<span class="sd">            '''</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_VERSION_REGEX</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                 <span class="k">return</span> <span class="bp">False</span>

             <span class="k">return</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">_get_version_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">            返回匹配备注文件中的版本信息</span>
<span class="sd">            '''</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_version</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span><span class="p">):</span>
                    <span class="n">version_file_content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_VERSION_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">version_file_content</span><span class="p">)</span>

         <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
             <span class="sd">'''</span>
<span class="sd">             返回distro的版本信息</span>
<span class="sd">             '''</span>
             <span class="n">version</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO_VERSION</span>
             <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_match</span><span class="p">()</span>
             <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                     <span class="n">version</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
             <span class="k">return</span> <span class="n">version</span>

        <span class="k">def</span> <span class="nf">check_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">            检查是否存在符合条件的版本号</span>
<span class="sd">            '''</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_version</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CHECK_VERSION_REGEX</span><span class="o">.</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">             返回 distro的版本号</span>
<span class="sd">            '''</span>
             <span class="n">release</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO_RELEASE</span>
             <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_match</span><span class="p">()</span>
             <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                     <span class="n">release</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
             <span class="k">return</span> <span class="n">release</span>

        <span class="k">def</span> <span class="nf">get_distro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">'''</span>
<span class="sd">            返回 class:'LinuxDistro' probe detected</span>
<span class="sd">            '''</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO_VERSION</span>
            <span class="n">release</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO_RELEASE</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO_ARCH</span>

            <span class="n">distro</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_name_for_file</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_for_file</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_name_for_file_contains</span><span class="p">():</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_for_file_contains</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_version</span><span class="p">():</span>
                <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_release</span><span class="p">():</span>
                <span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># 实在想不到比这更好的方式</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>

            <span class="c1"># 名字是首先要侦测的.它可以告诉我们是哪个发行版.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">distro</span> <span class="o">=</span> <span class="n">LinuxDistro</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">arch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">distro</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO</span>

            <span class="k">return</span> <span class="n">distro</span>

    <span class="k">class</span> <span class="nc">StdLibProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">         Probe是使用python库内建的probe.</span>
<span class="sd">         这个Probe得分比较低,作为备用probe.</span>
<span class="sd">        '''</span>

        <span class="k">def</span> <span class="nf">get_distro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO_VERSION</span>
            <span class="n">realease</span> <span class="o">=</span> <span class="n">UNKONWN_DISTRO_RELEASE</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">UNKONWN_DISTRO_ARCH</span>

            <span class="n">d_name</span><span class="p">,</span> <span class="n">d_version_release</span><span class="p">,</span> <span class="n">d_codename</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">dist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">d_name</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">d_name</span>

            <span class="k">if</span> <span class="s1">'.'</span> <span class="ow">in</span> <span class="n">d_version_release</span><span class="p">:</span>
                <span class="n">d_version</span><span class="p">,</span> <span class="n">d_release</span> <span class="o">=</span> <span class="n">d_version_release</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">d_version</span>
                <span class="n">release</span> <span class="o">=</span> <span class="n">d_release</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">d_version_release</span>

             <span class="n">arch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>

             <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                 <span class="n">distro</span> <span class="o">=</span> <span class="n">LinuxDistro</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">release</span><span class="p">,</span> <span class="n">arch</span><span class="p">)</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">distro</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO</span>

             <span class="k">return</span> <span class="n">distro</span>

    <span class="k">class</span> <span class="nc">RedHatProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">)</span>

        <span class="sd">'''</span>
<span class="sd">        红帽发行版版本检查</span>
<span class="sd">        '''</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/redhat=release'</span>
        <span class="n">CHECK_FILE_CONTAINS</span> <span class="o">=</span> <span class="s1">'Red Hat'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'redhat'</span>
        <span class="n">CHECK_VERSION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="s1">r'Red Hat Enterprise Linux Server release(\d{1,2})\.(\d{1,2}).*'</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">CentosProbe</span><span class="p">(</span><span class="n">RedHatProbe</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        Centos系统检测</span>
<span class="sd">        '''</span>

        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/redhat-release'</span>
        <span class="n">CHECK_FILE_CONTAINS</span> <span class="o">=</span> <span class="s1">'CentOS'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'centos'</span>
        <span class="n">CHECK_VERSION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r'CentOS release(\d{1,2})\.(\d{1,2}).*'</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">FedoraProbe</span><span class="p">(</span><span class="n">RedHatProbe</span><span class="p">):</span>

        <span class="sd">'''</span>
<span class="sd">        Probe with version checks for Fedora systems</span>
<span class="sd">        '''</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/fedora-release'</span>
        <span class="n">CHECK_FILE_CONTAINS</span> <span class="o">=</span> <span class="s1">'Fedora'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'fedora'</span>
        <span class="n">CHECK_VERSION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r'Fedora release (\d{1,2}).*'</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">DebianProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>

        <span class="sd">'''</span>
<span class="sd">        Simple probe with file checks for Debian systems</span>
<span class="sd">        '''</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/debian-version'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'debian'</span>


    <span class="k">class</span> <span class="nc">UbuntuProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>

        <span class="sd">'''</span>
<span class="sd">        Simple probe with file checks for Ubuntu systems</span>
<span class="sd">        '''</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/os-release'</span>
        <span class="n">CHECK_FILE_CONTAINS</span> <span class="o">=</span> <span class="s1">'Ubuntu'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'ubuntu'</span>
        <span class="n">CHECK_VERSION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r'VERSION_ID="(\d+.\d+)"'</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">SuseProbe</span><span class="p">(</span><span class="n">Probe</span><span class="p">):</span>
        <span class="n">CHECK_FILE</span> <span class="o">=</span> <span class="s1">'/etc/SuSE-release'</span>
        <span class="n">CHECK_FILE_DISTRO_NAME</span> <span class="o">=</span> <span class="s1">'sles'</span>
        <span class="n">CHECK_VERSION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r'SUSE.*\nVERSION = (.*)\nPATCHLEVEL = (.*)'</span><span class="p">)</span>


    <span class="c1">#: 已注册probes列表</span>
    <span class="n">REGISTERED_PROBES</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
<p><strong>register_probe</strong> <span id="register_probe">:</span></p>
<div class="highlight"><pre><span></span>    <span class="n">register_probe</span><span class="p">():</span>
        <span class="k">def</span> <span class="nf">register_probe</span><span class="p">(</span><span class="n">probe_class</span><span class="p">):</span> 
        <span class="sd">'''</span>
<span class="sd">        注册probe</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="n">probe_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REGISTERED_PROBES</span><span class="p">:</span>
            <span class="n">REGISTERED_PROBES</span><span class="o">.</span><span class="n">appen</span><span class="p">(</span><span class="n">probe_class</span><span class="p">)</span>

    <span class="n">register_probe</span><span class="p">(</span><span class="n">RedHatProbe</span><span class="p">)</span>
    <span class="n">register_probe</span><span class="p">(</span><span class="n">CentosProbe</span><span class="p">)</span>
    <span class="n">register_probe</span><span class="p">(</span><span class="n">FedoraProbe</span><span class="p">)</span>
    <span class="n">register_probe</span><span class="p">(</span><span class="n">DebianProbe</span><span class="p">)</span>
    <span class="n">register_probe</span><span class="p">(</span><span class="n">UbuntuProbe</span><span class="p">)</span>
    <span class="n">register_probe</span><span class="p">(</span><span class="n">SuseProbe</span><span class="p">)</span>
    <span class="n">register_probe</span><span class="p">(</span><span class="n">StdLibProbe</span><span class="p">)</span>
</pre></div>
<p><strong>detect</strong> <span id="detect">:</span></p>
<div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">detect</span><span class="p">():</span>
        <span class="sd">'''</span>
<span class="sd">        尝试在机器上侦测发行版</span>
<span class="sd">　　    '''</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">probe_class</span> <span class="ow">in</span> <span class="n">REGISTERED_PROBES</span><span class="p">:</span>
            <span class="n">probe_instance</span> <span class="o">=</span> <span class="n">probe_class</span><span class="p">()</span>
            <span class="n">didtro_result</span> <span class="o">=</span> <span class="n">probe_instance</span><span class="o">.</span><span class="n">get_distro</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">distro_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UNKNOWN_DISTRO</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">distro_result</span><span class="p">,</span> <span class="n">probe_instance</span><span class="p">))</span>

        <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">distro</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distro</span> <span class="o">=</span> <span class="n">UNKNOWN_DISTRO</span>
        <span class="k">return</span> <span class="n">dostro</span>

    <span class="k">class</span> <span class="nc">Spec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        发行版最低发行要求</span>
<span class="sd">　　　　 '''</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">min_version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>     <span class="n">min_release</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_version</span> <span class="o">=</span> <span class="n">min_version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_release</span> <span class="o">=</span> <span class="n">min_release</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">arch</span>
</pre></div>
<p>Top<a href="">^</a></p>
<p>上一篇<a href="https://king32783784.github.io/2015/08/17/autotest/">Autotest：Autotest-Using and developing job profilers</a>
下一篇<a href="https://king32783784.github.io/2015/08/19/autotest/">Autotest:Autotest-others&gt;&gt;&gt;</a></p></body>	
						</div>
					</div>
			      
					<div style="clear: both;">&nbsp;</div>
                                        <div class="post">
                                        <h2 class="title">Commentaires !</h2>
                                            <div id="disqus_thread"></div>
                                            <script type="text/javascript">
                                               var disqus_identifier = "2015/08/18/autotest/";
                                               (function() {
                                               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                                               dsq.src = 'https://xiayfblackwhite.disqus.com/embed.js';
                                               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                                              })();
                                            </script>
                                        </div>
				</div>
				<!-- end #content -->
				<div id="sidebar">
					<div id="logo">
						<h1><a href="../../../..">Hi | World</a></h1>
					</div>
					<div id="menu">
						<ul>
							<li ><a href="../../../..">首页</a></li>
							<li ><a href="../../../../archives.html">归档</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/tech-share.html">归档</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/opensource.html">开源项目</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/links.html">链接</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/Reference material.html">参考资料</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/todo list.html">Todo List</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/tools.html">工具集</a></li>
                                                            <li class="current_page_item"><a href="../../../../pages/aboutme.html">关于我</a></li>
						</ul>
					</div>
					<ul>
						<li>
							<h2>分类列表</h2>
							<ul>
								 <li ><a href="../../../../category/misc.html">misc</a></li>
								 <li class="active"><a href="../../../../category/autotestzhuan-ti.html">Autotest专题</a></li>
								 <li ><a href="../../../../category/suan-fa.html">算法</a></li>
								 <li ><a href="../../../../category/dockerzhuan-ti.html">Docker专题</a></li>
								 <li ><a href="../../../../category/linux.html">Linux</a></li>
								 <li ><a href="../../../../category/linux-benchmark.html">linux-benchmark</a></li>
								 <li ><a href="../../../../category/linux-zi-dong-hua-ce-shi.html">linux-自动化测试</a></li>
								 <li ><a href="../../../../category/unixhuan-jing-bian-cheng.html">unix环境编程</a></li>
								 <li ><a href="../../../../category/xing-neng-ce-shi.html">性能测试</a></li>
							</ul>
						</li>
						<li>
						        <h2>Tags</h2>
						        <ul>
                                                                <li><a href="../../../../tag/selenium.html">Selenium</a></li>
                                                                <li><a href="../../../../tag/zi-dong-hua-ce-shi.html">自动化测试</a></li>
                                                                <li><a href="../../../../tag/ltp.html">LTP</a></li>
                                                                <li><a href="../../../../tag/shell.html">shell</a></li>
                                                                <li><a href="../../../../tag/suan-fa.html">算法</a></li>
                                                                <li><a href="../../../../tag/xing-neng-ce-shi.html">性能测试</a></li>
                                                                <li><a href="../../../../tag/python.html">Python</a></li>
                                                                <li><a href="../../../../tag/docker.html">Docker</a></li>
                                                                <li><a href="../../../../tag/benchmark.html">benchmark</a></li>
                                                                <li><a href="../../../../tag/qi-ta.html">其他</a></li>
                                                                <li><a href="../../../../tag/unixbian-cheng.html">unix编程</a></li>
                                                                <li><a href="../../../../tag/linux.html">Linux</a></li>
                                                                <li><a href="../../../../tag/pyunit.html">PyUnit</a></li>
						        </ul>
						</li>
						
						
					</ul>
				</div>
				<!-- end #sidebar -->
				<div style="clear: both;">&nbsp;</div>
			</div>
		</div>
	</div>
	<!-- end #page -->

<div id="footer">
	<p>Copyright (c) 2008 Sitename.com. All rights reserved. Design by <a href="http://www.freecsstemplates.org/">CSS Templates</a>.</p>
	<p>Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
</p>
</div>
<!-- end #footer -->
</body>
</html>